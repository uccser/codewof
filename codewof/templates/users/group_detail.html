{% extends "base.html" %}
{% load static %}

{% load i18n %}
{% load crispy_forms_tags %}
{% load user_extras %}
{% load tz %}

{% block title %}{{ group.name }}{% endblock %}

{% block content %}
<div class="container">
  {% if is_admin %}
  <div id="alert-div" class="sticky-top" style="top: 40px">
    <div id="update-success-alert" class="alert alert-success alert-dismissible collapse" role="alert">
      Memberships successfully updated.
    </div>

    <div id="update-danger-alert" class="alert alert-danger alert-dismissible collapse" role="alert"></div>
  </div>

  <div id="demote-self-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Warning!</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>You are about to demote yourself. You will lose access to Admin privileges for this group.</p>

          <p>Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button id="demote-self-modal-button" type="button" class="btn btn-primary">Continue</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-12 col-md-8">
      <div class="row">
        <div class="col mb-3">
          <h1>{{ group.name }}</h1>
          <p>{{ group.description }}</p>
        </div>

        <div class="col-sm-auto mb-3">
          {% if is_admin %}
          <a class="btn btn-primary btn-sm d-block mb-1 mt-2" href="{% url 'users:groups-edit' group.pk %}">
            Edit Group</a>
          <a class="btn btn-danger btn-sm d-block mb-1" href="{% url 'users:groups-delete' group.pk %}">Delete Group</a>
          {% endif %}
          <a id="leave-button" class="btn btn-warning btn-sm d-block mb-1 {% if not is_admin %} mt-2 {% endif %}"
             {% if only_admin %} style="visibility: hidden" {% endif %}
             href="{% url 'users:groups-memberships-delete' user_membership.pk %}">Leave Group</a>
        </div>
      </div>

      <div class="row">
        <div class="col mb-3">
          {% if is_admin %}
          <a id="add-members-button" class="btn btn-primary mb-1 btn-sm float-right"
             href="{% url 'users:groups-memberships-invite' group.pk %}">Add Members</a>
          {% endif %}
          <h2>Members</h2>

          <table id="members-table" class="table">
            <thead>
            <tr>
              <th scope="col">Email</th>
              <th scope="col">Name</th>
              <th scope="col">Role</th>
              {% if is_admin %}
              <th scope="col">Remove?</th>
              {% endif %}
            </tr>
            </thead>

            <tbody id="members-table-tbody">
            {% for membership in memberships %}
            <tr id="membership-{{ membership.pk }}">
              <td>{{ membership.user.email }}</td>
              <td>{{ membership.user.first_name }} {{ membership.user.last_name }}</td>
              {% if is_admin %}
              <td>
                <select id="membership-{{ membership.pk }}-select" class="form-select"
                        aria-label="Default select example" autocomplete=off>
                  {% for role in roles %}
                  {% if role == membership.role %}
                  <option selected>{{ role }}</option>
                  {% else %}
                  <option>{{ role }}</option>
                  {% endif %}}
                  {% endfor %}
                </select>
              </td>
              <td class="text-center">
                <input id="membership-{{ membership.pk }}-checkbox" class="form-check-input" type="checkbox" value=""
                       autocomplete=off {% if user.pk == membership.user.pk %}disabled{% endif %}>
              </td>
              {% else %}
              <td>{{ membership.role }}</td>
              {% endif %}
            </tr>
            {% endfor %}
            </tbody>

          </table>
        </div>
      </div>

      <div class="row">
        <div class="col mb-3">
          <button id="email-button" class="btn btn-primary btn-sm">Email All</button>
          {% if is_admin %}
          <button id="save-button" class="btn btn-success btn-sm float-right">Save</button>
          {% endif %}
        </div>
      </div>
    </div>

    {% if feed %}
    <div class="col-12 col-md-4 mb-3">
      <h2>Feed</h2>

      <table class="table">
        <tbody id="feed-table-tbody">
        <script>let attemptLikeNames = {}</script>
        <script>let likeNames = []</script>
        {% for attempt in feed %}
        {% get_attempt_like_users_for_group attempt group.pk as like_users %}
        <tr id="attempt-{{ attempt.pk }}">
          <td class="feed-text">{{ attempt.profile.user.first_name }} {{ attempt.profile.user.last_name }} answered
            <a href="{% url 'programming:question' attempt.question.pk %}">{{ attempt.question.title }}</a>
            <br><small class="text-muted">{{ attempt.datetime|localtime }}</small>
          </td>

          <td class="align-middle td-thumb">
            <label><input class="thumb" autocomplete=off type="checkbox" {% if user in like_users %}
                          checked {% endif %} {% if user.pk == attempt.profile.user.pk %} disabled {% endif %}>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                   class="bi bi-hand-thumbs-up"
                   viewBox="0 0 16 16">
                {% if user in like_users %}
                <path class="thumb-path"
                      d="M6.956 1.745C7.021.81 7.908.087 8.864.325l.261.066c.463.116.874.456 1.012.965.22.816.533 2.511.062 4.51a9.84 9.84 0 0 1 .443-.051c.713-.065 1.669-.072 2.516.21.518.173.994.681 1.2 1.273.184.532.16 1.162-.234 1.733.058.119.103.242.138.363.077.27.113.567.113.856 0 .289-.036.586-.113.856-.039.135-.09.273-.16.404.169.387.107.819-.003 1.148a3.163 3.163 0 0 1-.488.901c.054.152.076.312.076.465 0 .305-.089.625-.253.912C13.1 15.522 12.437 16 11.5 16H8c-.605 0-1.07-.081-1.466-.218a4.82 4.82 0 0 1-.97-.484l-.048-.03c-.504-.307-.999-.609-2.068-.722C2.682 14.464 2 13.846 2 13V9c0-.85.685-1.432 1.357-1.615.849-.232 1.574-.787 2.132-1.41.56-.627.914-1.28 1.039-1.639.199-.575.356-1.539.428-2.59z"/>
                {% else %}
                <path class="thumb-path"
                      d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                {% endif %}
              </svg>
            </label>
          </td>

          <td class="align-middle td-like-count">
            <script>likeNames = []</script>
            {% for user in like_users %}
              <script>likeNames.push("{{ user.full_name }}")</script>
            {% endfor %}
            <script>attemptLikeNames["{{ attempt.pk }}"] = likeNames</script>
            <span class="span-like-count" data-toggle="tooltip" data-placement="right">{{ like_users.count }}
            </span>
          </td>
        </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block css %}
{{ block.super }}
<link href="{% static 'css/group_detail.css' %}" rel="stylesheet">
{% endblock css %}

{% block scripts %}
{% csrf_token %}
<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const membershipsUpdateURL = "{% url 'users:groups-memberships-update' group.pk %}";
  const emailURL = "{% url 'users:groups-emails' group.pk %}";
  const currentUserMembershipID = "{{ user_membership.pk }}";
  const userFullName = "{{ user.full_name }}";
  const feedEnabled = "{% if feed %}true{% else %}false{% endif %}" === 'true';
  function getLikeURL(attemptID) {
    return `{% url 'programming:like_attempt' 0 %}`.replace("0", attemptID);
  }
  function getUnlikeURL(attemptID) {
    return `{% url 'programming:unlike_attempt' 0 %}`.replace("0", attemptID);
  }
</script>

<script src="{% static 'js/groups/group_detail_general.js' %}"></script>
{% if is_admin %}
<script src="{% static 'js/groups/group_detail_admin.js' %}"></script>
{% endif %}
{% endblock scripts %}
